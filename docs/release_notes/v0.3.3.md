# Jiva v0.3.3 — Context & Persona Alignment

**Release Date:** February 28, 2026  
**Type:** Feature Release

## Overview

This release implements the Context & Persona Alignment plan, making all three agents (Manager, Worker, Client) fully context-aware and consistent. It introduces persona-aware validation for the Client agent and replaces the blunt `failureCount` escalation with a richer `CompletionSignal` model for smarter per-subtask corrective strategies.

## New Features

### Shared `AgentContext` (Improvement #1)

- **`AgentContext` type** (`src/core/types/agent-context.ts`): A shared payload containing workspace directory, fresh directive, bounded conversation history (user + assistant + tool roles), and persona context — built once per turn by `DualAgent.buildAgentContext()` and passed to all three agents.
- **`serializeAgentContext()` utility** (`src/core/utils/serialize-agent-context.ts`): Produces a consistent, role-appropriate string block for each agent with configurable token budget limits.
- **Fresh directive per call**: Manager no longer bakes the directive at construction time — it is injected fresh each LLM call, so mid-session directive changes are reflected immediately.
- **Worker now receives directive**: Previously missing, the Worker's system prompt now includes the directive.
- **Client receives full context**: Directive, conversation history, and persona validation context are now included in all Client LLM prompts.
- **Conversation history includes all roles**: `getRecentContext()` now includes `user`, `assistant`, and `tool` messages (previously user-only), preventing coherence failures and duplicate tool calls.

### Client Persona Awareness (Improvement #2)

- **`buildValidationContext()` in DualAgent**: Generates a validation-specific persona context for the Client containing persona name, skill names/descriptions, and constraints — deliberately different from the execution block given to Manager/Worker.
- **Validation-framed persona context**: The Client sees what correct behavior looks like (descriptive, criteria-oriented) rather than how to behave (which would risk the Client directing execution).

### CompletionSignal (Improvement #3)

- **`CompletionSignal` type** (`src/core/types/completion-signal.ts`): A per-subtask assessment with `confidence`, `progressMade`, `blockerType`, and `suggestedStrategy` fields.
- **`analyzeCompletionSignal()` in ClientAgent**: LLM-based analysis producing a signal alongside each `ValidationResult`.
- **Per-subtask retry budget**: Each subtask gets up to 2 correction attempts (configurable). Budget resets per subtask — no session-wide escalation.
- **Corrective strategy dispatch**: `DualAgent` reads `CompletionSignal.blockerType` to choose retry, rephrase, decompose, skip, or escalate — replacing the blunt `failureCount` escalation.
- **`failureCount` demoted to telemetry-only**: No longer drives involvement level escalation. `THOROUGH` involvement is now reserved for explicit user test requests.
- **`resetFailureTracking()` → `resetSessionState()`**: Renamed for clarity (old method kept as deprecated alias for backward compatibility).

### Sub-Agent Context Guidance (Improvement #4 — Phase 1)

- **Prompt-level convention**: Worker's `spawn_agent` documentation now instructs Manager to include relevant directive constraints and conversation summary when spawning sub-agents.
- **AgentSpawner documentation**: Phase 2 note added for optional `parentContext` parameter.

## Bug Fixes

- **`getRecentContext()` now includes assistant + tool roles** — fixes coherence failures where agents couldn't see prior outputs.
- **Manager directive is no longer stale** — fresh directive injected per LLM call instead of only at construction.
- **Worker receives directive** — previously had no access to workspace directive.
- **Client receives workspace context** — now has directive, conversation history, and persona validation context.

## Upgrade Instructions

```bash
npm install -g jiva-core@0.3.3
```

## Backward Compatibility

- All changes are additive. Existing consumers that only read `approved` / `issues` / `nextAction` from `ValidationResult` are unaffected.
- `resetFailureTracking()` still works (deprecated alias for `resetSessionState()`).
- Default behavior remains the same for users without directives or personas.
